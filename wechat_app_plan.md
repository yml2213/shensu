# 微信多账号提交工具开发计划

## 目标与范围
- 提供基于 Python + Tkinter 的桌面端应用，用于管理多个微信账号及其每日提交次数。
- 支持通过接口获取登录 code，并在界面中展示或触发登录动作。
- 使用本地 JSON 文件实现轻量持久化，记录账号、手机号、提交历史、登录 code 与导入的用户素材。
- 实现手机号换绑功能，并预留对接 API 平台的换绑接口；换绑后重新计算提交额度。
- 支持导入用户资料（手机号、姓名、原因、照片等），避免重复导入，并在提交时优先匹配手机号信息。

## 技术选型
- 应用框架：Python 3.11 + Tkinter（配合 ttk/ttkbootstrap 提升界面表现）。
- 业务组织：`dataclasses` + 模块化服务层（账号管理、提交控制、code 获取、换绑流程、数据导入）。
- 存储：标准库 `json` + 文件锁封装，初期使用多 JSON 文件，后续可升级到 TinyDB/SQLite。
- 依赖与环境：使用 `uv` 管理虚拟环境与依赖，基于 `pyproject.toml` 配置项目。
- 网络请求：`requests`（支持超时、重试、统一错误处理）。
- 日志：`logging` 标准库，按日期输出日志文件，记录接口调用与导入过程。
- 打包：`pyinstaller` 生成独立可执行文件，视需求扩展其他打包方案。

## 模块划分
- `ui/`
  - 主窗口、账号列表、提交面板、导入向导、换绑对话框、日志面板。
- `services/`
  - `account_service.py`：账号 CRUD、手机号关联、提交计数更新。
  - `code_service.py`：调用外部接口获取 code，处理缓存与过期。
  - `submission_service.py`：执行提交逻辑、额度控制、跨天重置。
  - `phone_service.py`：手机号额度统计、换绑与 API 对接占位。
  - `import_service.py`：解析导入文件、校验重复、整理照片路径。
  - `api_client.py`：封装对外 API 调用（code、换绑等），便于后续扩展。
- `storage/`
  - `json_store.py`：统一的数据读写接口，封装锁与原子写入。
  - `models.py`：数据结构定义（`Account`, `PhoneQuota`, `Session`, `PersonProfile`, `MediaAsset` 等）。
  - `media/`：存放导入的照片文件，可按手机号/日期归档。
- `tasks/`：定时任务或启动检查逻辑（重置额度、清理过期 code、同步 API 状态）。
- `tests/`：使用 `pytest` 覆盖核心业务逻辑与数据导入流程。

## 数据模型草案
- `accounts.json`
  - `wechat_id`
  - `display_name`
  - `phone`
  - `quota`：`{"date": "2024-05-20", "count": 2}`
  - `person_id`：关联导入的用户资料
  - `events`: 换绑或提交日志
  - `created_at` / `updated_at`
- `phones.json`
  - `phone`
  - `date`
  - `submit_count`
  - `last_account_ids`
- `sessions.json`
  - `wechat_id`
  - `login_code`
  - `expired_at`
  - `last_fetch_at`
- `persons.json`
  - `person_id`
  - `name`
  - `phone`
  - `reason`
  - `photo_paths`: 数组，保存本地照片相对路径
  - `meta`: 导入来源、备注
  - `created_at` / `updated_at`
- `media/`
  - 照片按 `phone/YYYYMMDD_filename.ext` 存放，`import_service` 负责拷贝或生成软链接，避免重复。

## 核心业务规则
- **提交限制**
  - 微信号与手机号各自每天最多 3 次提交；统计日期基于本地时间（默认 00:00 重置）。
  - 提交时优先匹配导入的手机号资料，若缺失则提示导入或手动补充。
  - 惩罚重复提交：同一手机号或账号超过额度直接禁止，需等待次日。
  - 接口约定：成功返回 code=200、msg="请求成功"；超限返回 code=400、msg="您的申诉次数已经达到上限"，需在界面提示并阻止重复提交。
- **code 获取流程**
  - 在界面点击“获取 code”后调用接口（通过 `api_client`），UI 展示 code、倒计时与状态。
  - 失败时记录日志，提供手动输入或重试入口。
- **手机号换绑**
  - 选择账号 → 输入新手机号 → 触发对接 API 的换绑占位流程（先调用模拟接口，后续接入真实 API）。
  - API 成功返回后更新账号绑定、重置提交计数、同步导入资料。
  - 新手机号如未导入资料，可提示即时导入或关联已有资料。
- **数据导入**
  - 支持从 CSV/Excel/JSON 导入手机号、姓名、原因、照片路径（或压缩包）。
  - 导入前校验格式；导入时根据手机号去重，已有资料可选择覆盖或跳过。
  - 照片统一复制到 `media/` 目录，并更新 `persons.json`，避免重复导入。
- **数据一致性**
  - 写入 JSON 使用临时文件 + 原子替换，通过文件锁避免并发问题。
  - 启动时若检测到日期变更，自动重置账号和手机号的提交次数。

## 迭代开发步骤
1. **迭代一：项目初始化与基础设施**
   - 使用 `uv` 初始化项目结构（如 `uv init`），创建 `src` 目录与虚拟环境，并通过 `uv add` 引入 requests、pytest、ttkbootstrap 等依赖。
   - 实现 `json_store`、`models`、日志配置。
   - 设计 `media/` 目录及配置文件（默认路径、API 基础设置）。

2. **迭代二：Tkinter 界面框架**
   - 构建主窗口、导航、内容区域占位。
   - 初始化账号列表视图和导入占位按钮。
   - 应用统一主题与基本布局管理。

3. **迭代三：账号管理功能**
   - 实现账号增删改查界面与服务层联动。
   - 列表中展示提交剩余额度、关联手机号与导入资料状态。
   - 增加基础搜索或排序能力。

4. **迭代四：数据导入与资料管理**
   - 开发导入向导：支持 CSV/Excel（可使用 `pandas` 或 `csv`/`openpyxl`）。
   - 实现 `import_service`，处理去重、覆盖策略、照片文件管理。
   - 在 UI 中展示导入记录，支持查看与手动关联账号。

5. **迭代五：code 获取与展示**
   - 实装 `api_client` 的 code 获取接口封装，添加超时重试。
   - UI 增加“获取 code”按钮、状态展示、复制功能。
   - 将 code 信息持久化至 `sessions.json`，并在过期时提示刷新。

6. **迭代六：提交与额度控制**
   - 完成提交操作流程，调用占位接口（后续可对接真实提交 API）。
   - 检查微信号与手机号额度，确保导入资料与提交紧密关联。
   - 实现跨天重置与状态提示，对超限账号/手机号进行明显标识。

7. **迭代七：手机号换绑与 API 对接占位**
   - 编写换绑对话框，调用 `api_client` 中的占位换绑接口。
   - API 成功后更新账号与手机号关系、重置额度、记录事件。
   - 为后续对接真实 API 预留配置项与异常处理。

8. **迭代八：测试、打包与文档**
   - 使用 pytest 覆盖提交额度计算、导入逻辑、换绑流程、API 失败回退等。
   - 编写使用手册（导入格式、照片目录、API 配置说明）。
   - 配置 pyinstaller 脚本，完成可执行文件构建与冒烟测试。

## 里程碑
- `M1`：迭代三完成，账号管理与基础界面可用。
- `M2`：迭代六完成，提交流程与额度控制稳定运行。
- `M3`：迭代八完成，具备导入、换绑占位与打包能力，可内部试用。

## 风险与应对
- **导入数据质量不一**：提供模板与校验规则，对异常记录生成报告供用户修复。
- **照片体积大或路径不可用**：导入时验证文件存在性，支持压缩包解压；提供失败列表。
- **API 对接不确定**：先实现模拟接口与配置抽象，待明确平台文档后替换；日志记录请求/响应。
- **Tkinter 可维护性**：拆分组件与服务层，使用事件/回调管理状态，避免界面逻辑混乱。
- **JSON 写入冲突**：使用文件锁与备份策略；若未来扩展多人协作，考虑迁移到 SQLite。

## 后续扩展方向
- 引入批量自动提交任务（结合 APScheduler 和 API 队列）。
- 增加多用户权限控制与操作审计。
- 将导入/提交/换绑操作抽象为 REST API，供其他系统调用。
- 支持云端备份和同步，或迁移至更可靠的数据库方案。
